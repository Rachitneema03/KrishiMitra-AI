# app.py - KrishiMitra (Bilingual Version)
import requests
from dotenv import load_dotenv
import os
import json
import re
import streamlit as st
import spacy
from googletrans import Translator
import time
# --- IMPORT THE REAL DIAGNOSIS FUNCTION ---
from model.pest_detector import diagnose_plant_disease

# --- 1. TEXT & LOCALIZATION ---
TEXT = {
    # ... (all your text content remains the same) ...
    "page_title": {"en": "KrishiMitra", "hi": "рдХреГрд╖рд┐ рдорд┐рддреНрд░"},
    "page_icon": "ЁЯМ┐",
    "sidebar_title": {"en": "ЁЯМ┐ KrishiMitra", "hi": "ЁЯМ┐ рдХреГрд╖рд┐ рдорд┐рддреНрд░"},
    "sidebar_welcome": {"en": "Welcome to KrishiMitra, your AI-powered farming assistant.", "hi": "рдХреГрд╖рд┐ рдорд┐рддреНрд░ рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ, рдпрд╣ рдЖрдкрдХрд╛ AI-рд╕рдВрдЪрд╛рд▓рд┐рдд рдЦреЗрддреА рд╕рд╣рд╛рдпрдХ рд╣реИред"},
    "sidebar_what_i_do": {"en": "**What can I do?**", "hi": "**рдореИрдВ рдХреНрдпрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?**"},
    "sidebar_feature_1": {"en": "- ЁЯУИ Provide current market prices.", "hi": "- ЁЯУИ рдлрд╕рд▓реЛрдВ рдХреЗ рдмрд╛рдЬрд╛рд░ рднрд╛рд╡ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ред"},
    "sidebar_feature_2": {"en": "- ЁЯМжя╕П Give you a weather forecast.", "hi": "- ЁЯМжя╕П рдореМрд╕рдо рдХрд╛ рдкреВрд░реНрд╡рд╛рдиреБрдорд╛рди рджреЗрдирд╛ред"},
    "sidebar_feature_3": {"en": "- ЁЯФм Diagnose plant diseases from a photo.", "hi": "- ЁЯФм рддрд╕реНрд╡реАрд░ рд╕реЗ рдкреМрдзреЛрдВ рдХреА рдмреАрдорд╛рд░рд┐рдпреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ред"},
    "app_title": {"en": "ЁЯдЦ KrishiMitra Assistant", "hi": "ЁЯдЦ рдХреГрд╖рд┐ рдорд┐рддреНрд░ рд╕рд╣рд╛рдпрдХ"},
    "app_intro": {"en": "Ask me about crop prices, weather, or upload a photo of a sick plant!", "hi": "рдореБрдЭрд╕реЗ рдлрд╕рд▓ рдХреА рдХреАрдорддреЛрдВ, рдореМрд╕рдо рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрдЫреЗрдВ, рдпрд╛ рдХрд┐рд╕реА рдмреАрдорд╛рд░ рдкреМрдзреЗ рдХреА рддрд╕реНрд╡реАрд░ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ!"},
    "welcome_message": {"en": "Hello, farmer! How can I help you today?", "hi": "рдирдорд╕реНрддреЗ рдХрд┐рд╕рд╛рди! рдореИрдВ рдЖрдкрдХреА рдХреИрд╕реЗ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?"},
    "chat_placeholder": {"en": "What do you need help with?", "hi": "рдЖрдк рдХреНрдпрд╛ рдорджрдж рдЪрд╛рд╣рддреЗ рд╣реИрдВ?"},
    "spinner_thinking": {"en": "Thinking...", "hi": "рд╕реЛрдЪ рд░рд╣рд╛ рд╣реВрдБ..."},
    "spinner_analyzing": {"en": "Analyzing the image...", "hi": "рддрд╕реНрд╡реАрд░ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рд╣реЛ рд░рд╣рд╛ рд╣реИ..."},
    "upload_prompt": {"en": "Choose a plant leaf image...", "hi": "рдкреМрдзреЗ рдХреА рдкрддреНрддреА рдХреА рдПрдХ рддрд╕реНрд╡реАрд░ рдЪреБрдиреЗрдВ..."},
    "upload_caption": {"en": "Uploaded Image.", "hi": "рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ рддрд╕реНрд╡реАрд░ред"},
    "trigger_disease": {"en": "It sounds like you have a sick plant. **Please upload a photo of the affected leaf below.**", "hi": "рд▓рдЧрддрд╛ рд╣реИ рдЖрдкрдХреЗ рдкреМрдзреЗ рдореЗрдВ рдХреЛрдИ рдмреАрдорд╛рд░реА рд╣реИред **рдХреГрдкрдпрд╛ рдиреАрдЪреЗ рдкреНрд░рднрд╛рд╡рд┐рдд рдкрддреНрддреА рдХреА рддрд╕реНрд╡реАрд░ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред**"},
    "trigger_upload_check": {"en": "upload a photo", "hi": "рддрд╕реНрд╡реАрд░ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ"},
    "post_diagnosis_message": {"en": "Here is the diagnosis for your plant.", "hi": "рдЖрдкрдХреЗ рдкреМрдзреЗ рдХреА рдЬрд╛рдВрдЪ рдХреА рд░рд┐рдкреЛрд░реНрдЯ рдпрд╣рд╛рдБ рд╣реИред"},
    "fallback_message": {"en": "I'm sorry, I can only help with market prices, weather, and plant diseases. Please try asking one of those.", "hi": "рдорд╛рдлрд╝ рдХреАрдЬрд┐рдП, рдореИрдВ рдХреЗрд╡рд▓ рдмрд╛рдЬрд╛рд░ рднрд╛рд╡, рдореМрд╕рдо, рдФрд░ рдкреМрдзреЛрдВ рдХреА рдмреАрдорд╛рд░рд┐рдпреЛрдВ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБред рдХреГрдкрдпрд╛ рдЗрдирдореЗрдВ рд╕реЗ рдХреЛрдИ рдПрдХ рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВред"}
}

# Translation function
def simple_translate_to_hindi(text_to_translate):
    translator = Translator()
    translation = translator.translate(text_to_translate, dest='hi')
    return translation.text

# --- 2. BILINGUAL AGENT FUNCTIONS ---

def get_market_price(crop_name, lang='en'):
    # ... (this function remains the same) ...
    prices = {
        "soybean": {"en": "The current market price for Soybean in Indore is тВ╣4,500 per quintal.", "hi": "рдЗрдВрджреМрд░ рдореЗрдВ рд╕реЛрдпрд╛рдмреАрди рдХрд╛ рдореМрдЬреВрджрд╛ рдмрд╛рдЬрд╛рд░ рднрд╛рд╡ тВ╣4,500 рдкреНрд░рддрд┐ рдХреНрд╡рд┐рдВрдЯрд▓ рд╣реИред"},
        "wheat": {"en": "The current market price for Wheat in Dewas is тВ╣2,100 per quintal.", "hi": "рджреЗрд╡рд╛рд╕ рдореЗрдВ рдЧреЗрд╣реВрдВ рдХрд╛ рдореМрдЬреВрджрд╛ рдмрд╛рдЬрд╛рд░ рднрд╛рд╡ тВ╣2,100 рдкреНрд░рддрд┐ рдХреНрд╡рд┐рдВрдЯрд▓ рд╣реИред"}
    }
    fallback = {"en": f"Sorry, I don't have the price for {crop_name}. I only have data for Soybean and Wheat.", "hi": f"рдорд╛рдлрд╝ рдХреАрдЬрд┐рдП, рдореЗрд░реЗ рдкрд╛рд╕ {crop_name} рдХрд╛ рднрд╛рд╡ рдирд╣реАрдВ рд╣реИред рдореЗрд░реЗ рдкрд╛рд╕ рдХреЗрд╡рд▓ рд╕реЛрдпрд╛рдмреАрди рдФрд░ рдЧреЗрд╣реВрдВ рдХреА рдЬрд╛рдирдХрд╛рд░реА рд╣реИред"}
    
    if "soybean" in crop_name.lower() or "рд╕реЛрдпрд╛рдмреАрди" in crop_name.lower():
        return prices["soybean"][lang]
    elif "wheat" in crop_name.lower() or "рдЧреЗрд╣реВрдВ" in crop_name.lower():
        return prices["wheat"][lang]
    else:
        return fallback[lang]
nlp = spacy.load("en_core_web_sm")
json_file_path = os.path.join(os.path.dirname(__file__), 'static', 'data.json')
INDIAN_CITIES = []
try:
    with open(json_file_path, 'r') as file:
        data = json.load(file)
        if isinstance(data, list):
            # Store a list of lowercase city names for easy matching
            INDIAN_CITIES = [city.lower() for city in data]
except (FileNotFoundError, json.JSONDecodeError) as e:
    st.error(f"Error loading cities file: {e}")
def extract_location(text):
    words = re.findall(r'\w+', text.lower())
    for city in INDIAN_CITIES:
        for word in words:
            if word == city:
                return city
    doc = nlp(text)
    for ent in doc.ents:
        if ent.label_ == "GPE":
            return ent.text
    return None
def get_weather_forecast(location, lang='en'):
    load_dotenv()
    """Returns weather forecast in the selected language."""

    api_key = os.getenv("WEATHER_API_KEY")
    if not api_key:
        return "Error: OpenWeather API key not found. Please set it in the .env file."
    base_url = "http://api.openweathermap.org/data/2.5/weather?"

    completeUrl = f"{base_url}q={location}&appid={api_key}&units=metric"
    try:
        response = requests.get(completeUrl)
        if response.status_code == 200:
            data = response.json()
            temperature = data['main']['temp']
            weatherDescription = data['weather'][0]['description']
            hindidescription = simple_translate_to_hindi(weatherDescription)
            humidity = data['main']['humidity']
            if "rain" in weatherDescription:
                # Use a more natural phrase for rain
                localized_description_en = "chance of light rain in the evening"
                localized_description_hi = "рд╢рд╛рдо рдХреЛ рд╣рд▓реНрдХреА рдмрд╛рд░рд┐рд╢ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИред"
            elif "clear sky" in weatherDescription:
                localized_description_en = "clear skies"
                localized_description_hi = "рдЖрд╕рдорд╛рди рд╕рд╛рдл рд░рд╣реЗрдЧрд╛ред"
            elif "clouds" in weatherDescription:
                localized_description_en = "cloudy skies"
                localized_description_hi = "рдЖрд╕рдорд╛рди рдореЗрдВ рдмрд╛рджрд▓ рдЫрд╛рдП рд░рд╣реЗрдВрдЧреЗред"
            elif "mist" in weatherDescription or "fog" in weatherDescription:
                localized_description_en = "misty conditions"
                localized_description_hi = "рд╣рд▓реНрдХреА рдзреБрдВрдз рд░рд╣реЗрдЧреАред"
            else:
                # Fallback to a simple translation if we don't have a specific phrase
                localized_description_en = weatherDescription
                localized_description_hi = "рдореМрд╕рдо рдХрд╛ рд╣рд╛рд▓ рд╣реИ: " + hindidescription
            # --- Build the Final Response Message ---
            if lang == 'hi':
                message = f"{location} рдХреЗ рд▓рд┐рдП рдореМрд╕рдо рдХрд╛ рд╣рд╛рд▓ рд╣реИ: {temperature}┬░C, {localized_description_hi} рдФрд░ {humidity}% рдЖрд░реНрджреНрд░рддрд╛ред"
            else:
                message = f"The weather forecast for {location} is: {temperature}┬░C, with {localized_description_en} and {humidity}% humidity."

            return message
        else:
            return {"en": f"Error: Could not retrieve weather data for {location}.", "hi": f"рддреНрд░реБрдЯрд┐: {location} рдХреЗ рд▓рд┐рдП рдореМрд╕рдо рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрд╛ред"}[lang]
    except requests.exceptions.RequestException as e:
        return f"A network error occurred: {e}"

# NOTE: The mocked diagnose_plant_disease function has been removed.

def route_query(query, lang='en'):
    """Router that directs query to the correct agent based on language."""
    query = query.lower()
    location = extract_location(query)
    # print(location)
    # --- EXPANDED KEYWORDS FOR BETTER DETECTION ---
    keywords = {
        "price": {"en": ["price", "rate", "cost", "mandi"], "hi": ["рднрд╛рд╡", "рджрд╛рдо", "рдХреАрдордд", "рдордВрдбреА"]},
        "weather": {"en": ["weather", "forecast", "temperature"], "hi": ["рдореМрд╕рдо", "рддрд╛рдкрдорд╛рди"]},
        "disease": {
            "en": ["disease", "sick", "pest", "leaf", "plant", "infection", "spots", "ill"],
            "hi": ["рдмреАрдорд╛рд░реА", "рд░реЛрдЧ", "рдкрддреНрддреА", "рдкреМрдзрд╛", "рд╕рдВрдХреНрд░рдордг", "рдзрдмреНрдмреЗ", "рдмреАрдорд╛рд░"]
        }
    }

    # --- ROUTING LOGIC (REMAINS THE SAME) ---
    if any(word in query for word in keywords["price"]["en"] + keywords["price"]["hi"]):
        return get_market_price(query, lang)
    elif any(word in query for word in keywords["weather"]["en"] + keywords["weather"]["hi"]):
        return get_weather_forecast(location, lang)
    elif any(word in query for word in keywords["disease"]["en"] + keywords["disease"]["hi"]):
        return TEXT["trigger_disease"][lang]
    else:
        return TEXT["fallback_message"][lang]

# --- 3. STREAMLIT APP ---

# --- Page Config ---
st.set_page_config(page_title=TEXT["page_title"]["en"], page_icon=TEXT["page_icon"], layout="centered")

# --- Language Selection ---
if 'language' not in st.session_state:
    st.session_state['language'] = 'en'
lang_choice = st.radio(
    "Choose Language / рднрд╛рд╖рд╛ рдЪреБрдиреЗрдВ:",
    ('English', 'рд╣рд┐рдВрджреА (Hindi)'),
    horizontal=True,
    key='lang_selector'
)
st.session_state.language = 'hi' if lang_choice == 'рд╣рд┐рдВрджреА (Hindi)' else 'en'
lang = st.session_state.language

# --- Sidebar ---
with st.sidebar:
    st.title(TEXT["sidebar_title"][lang])
    st.markdown(TEXT["sidebar_welcome"][lang])
    st.markdown(TEXT["sidebar_what_i_do"][lang])
    st.markdown(TEXT["sidebar_feature_1"][lang])
    st.markdown(TEXT["sidebar_feature_2"][lang])
    st.markdown(TEXT["sidebar_feature_3"][lang])

# --- Main App ---
st.title(TEXT["app_title"][lang])
st.write(TEXT["app_intro"][lang])

# --- NEW: Initialize Dual Chat History ---
if "messages_en" not in st.session_state:
    st.session_state.messages_en = [{"role": "assistant", "content": TEXT["welcome_message"]["en"]}]
    st.session_state.messages_hi = [{"role": "assistant", "content": TEXT["welcome_message"]["hi"]}]

# --- Display the Correct Chat History ---
display_messages = st.session_state.messages_hi if lang == 'hi' else st.session_state.messages_en
for message in display_messages:
    avatar = "ЁЯзСтАНЁЯМ╛" if message["role"] == "user" else "ЁЯдЦ"
    with st.chat_message(message["role"], avatar=avatar):
        st.markdown(message["content"])

# --- User Input & Agent Logic ---
if prompt := st.chat_input(TEXT["chat_placeholder"][lang]):
    # A. Append the user prompt to both histories with immediate translation
    prompt_hi = simple_translate_to_hindi(prompt) if lang == 'en' else prompt
    prompt_en = prompt if lang == 'en' else simple_translate_to_hindi(prompt)
    st.session_state.messages_en.append({"role": "user", "content": prompt_en})
    st.session_state.messages_hi.append({"role": "user", "content": prompt_hi})

    # B. Display the user message
    with st.chat_message("user", avatar="ЁЯзСтАНЁЯМ╛"):
        st.markdown(prompt)

    # C. Get the assistant's response
    with st.chat_message("assistant", avatar="ЁЯдЦ"):
        with st.spinner(TEXT["spinner_thinking"][lang]):
            response_text = route_query(prompt, lang)
            st.markdown(response_text)
    
    # D. Append the assistant's response to both histories
    response_en = response_text if lang == 'en' else simple_translate_to_hindi(response_text)
    response_hi = response_text if lang == 'hi' else simple_translate_to_hindi(response_text)
    st.session_state.messages_en.append({"role": "assistant", "content": response_en})
    st.session_state.messages_hi.append({"role": "assistant", "content": response_hi})
    st.rerun()

# --- Conditional File Uploader ---
# --- Conditional File Uploader ---
# Get the last message from the correct history list
last_message_list = st.session_state.messages_hi if lang == 'hi' else st.session_state.messages_en
if last_message_list and last_message_list[-1]["role"] == "assistant" and TEXT["trigger_upload_check"][lang] in last_message_list[-1]["content"]:
    
    uploaded_file = st.file_uploader(TEXT["upload_prompt"][lang], type=["jpg", "png", "jpeg"])
    
    if uploaded_file is not None:
        with open("temp_image.jpg", "wb") as f:
            f.write(uploaded_file.getbuffer())

        with st.chat_message("user", avatar="ЁЯзСтАНЁЯМ╛"):
            st.image(uploaded_file, caption=TEXT["upload_caption"][lang], width=150)
        
        # Append the image uploaded message to both histories
        image_uploaded_en = "[Image Uploaded]"
        image_uploaded_hi = "[рддрд╕реНрд╡реАрд░ рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ]"
        st.session_state.messages_en.append({"role": "user", "content": image_uploaded_en})
        st.session_state.messages_hi.append({"role": "user", "content": image_uploaded_hi})

        with st.chat_message("assistant", avatar="ЁЯдЦ"):
            with st.spinner(TEXT["spinner_analyzing"][lang]):
                # Get the diagnosis in English from your model
                diagnosis_en = diagnose_plant_disease("temp_image.jpg")
                # Translate it to Hindi
                diagnosis_hi = simple_translate_to_hindi(diagnosis_en)

                if lang == 'hi':
                    st.markdown(diagnosis_hi)
                else:
                    st.markdown(diagnosis_en)
        
        # Append the diagnosis to both histories
        st.session_state.messages_en.append({"role": "assistant", "content": diagnosis_en})
        st.session_state.messages_hi.append({"role": "assistant", "content": diagnosis_hi})
        
        # We also need to add the post-diagnosis message
        post_diag_en = TEXT["post_diagnosis_message"]["en"]
        post_diag_hi = TEXT["post_diagnosis_message"]["hi"]
        st.session_state.messages_en.append({"role": "assistant", "content": post_diag_en})
        st.session_state.messages_hi.append({"role": "assistant", "content": post_diag_hi})

        # --- IMPORTANT: Rerun the app to update the chat history ---
        st.rerun()